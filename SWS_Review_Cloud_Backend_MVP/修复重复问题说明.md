# 修复审查结果重复问题说明

## 问题描述

当运行审查任务时，发现同一个问题出现了多次，但检查点（checkpoint_code）不同。例如：

```
1. [S3] 表格未被引用：表7.1-2 (检查点: FMT_R_008)
2. [S3] 表格未被引用：表7.1-2 (检查点: FORMAT_TABLE)
3. [S3] 表格未被引用：表7.1-2 (检查点: FORMAT_UNIT)
4. [S3] 表格未被引用：表7.1-2 (检查点: FORMAT_REFERENCE)
...
```

## 问题原因

多个 checkpoint 配置了相同的 executor（如 `format_review`），但它们的 `rule_config_json` 中没有 `only_checks` 字段。

例如：
- `FORMAT_STRUCTURE` 使用 `format_review` executor
- `FORMAT_NUMBERING` 使用 `format_review` executor
- `FORMAT_REFERENCE` 使用 `format_review` executor
- `FORMAT_UNIT` 使用 `format_review` executor
- `FORMAT_TABLE` 使用 `format_review` executor

当这些 checkpoint 被调用时：
1. 每个 checkpoint 都会调用 `run_format_review` executor
2. 由于没有 `only_checks` 配置，`run_format_review` 会执行**所有**的 checks
3. 每个 checkpoint 都返回相同的问题列表
4. 导致同一个问题被标记为不同的 `checkpoint_code`，产生重复

## 解决方案

为每个 checkpoint 添加 `only_checks` 配置，指定该 checkpoint 应该执行哪些具体的检查。

### 执行迁移

```bash
# Windows
执行迁移009.bat

# 或直接运行Python脚本
python 执行迁移009.py
```

### 配置映射

迁移会为以下 checkpoint 添加 `only_checks` 配置：

#### 格式审查（Format Review）

| Checkpoint Code | only_checks |
|----------------|-------------|
| `FORMAT_STRUCTURE` | `cover_required_elements`, `toc_present` |
| `FORMAT_NUMBERING` | `heading_numbering`, `figure_numbering`, `table_numbering` |
| `FORMAT_REFERENCE` | `table_referenced`, `figure_referenced` |
| `FORMAT_UNIT` | `unit_symbol_consistency`, `table_unit_column_present` |
| `FORMAT_TABLE` | `table_caption_present`, `table_numbering`, `table_referenced`, `table_unit_column_present` |

#### 内容审查（Content Review）

| Checkpoint Code | only_checks |
|----------------|-------------|
| `CONTENT_SECTIONS` | `required_sections` |
| `CONTENT_TRIGGER` | `trigger_requirements` |
| `CONTENT_ELEMENTS` | `required_elements` |

## 验证

迁移执行后，可以运行以下SQL验证：

```sql
-- 检查only_checks配置
SELECT code, name, rule_config_json->'only_checks' as only_checks
FROM sws.review_checkpoint
WHERE code IN ('FORMAT_STRUCTURE', 'FORMAT_NUMBERING', 'FORMAT_REFERENCE', 'FORMAT_UNIT', 'FORMAT_TABLE',
               'CONTENT_SECTIONS', 'CONTENT_TRIGGER', 'CONTENT_ELEMENTS')
ORDER BY code;
```

## 效果

迁移后，重新运行审查任务：
- ✅ 每个 checkpoint 只执行指定的 checks
- ✅ 不会再有重复的问题
- ✅ 每个问题只对应一个 checkpoint_code

## 注意事项

- **一致性审查、表内计算、公式计算**等 executor 通常每个 checkpoint 执行所有检查，这些不需要 `only_checks`，因为它们本身就是原子检查
- 如果以后添加新的 checkpoint，记得为它们配置 `only_checks`，避免重复问题

## 相关文件

- 迁移SQL文件：`docs/migrations/009_fix_checkpoint_only_checks.sql`
- 执行脚本：`执行迁移009.py`
- 批处理脚本：`执行迁移009.bat`

## 额外建议：禁用旧的重复checkpoint

如果数据库中同时存在旧的checkpoint（`FORMAT_*`、`CONTENT_*`）和新的checkpoint（`FMT_R_*`、`CNT_R_*`），建议执行迁移010来禁用旧的checkpoint：

```bash
# Windows
执行迁移010.bat

# 或直接运行Python脚本
python 执行迁移010.py
```

这样可以：
- ✅ 避免新旧checkpoint同时运行导致重复
- ✅ 统一使用新的checkpoint命名规范
- ✅ 简化checkpoint管理
