# 审查任务诊断与直接执行说明

## 问题背景

当审查任务状态一直为 `PENDING` 时，通常是因为：
1. Celery Worker 未运行
2. Celery Worker 无法连接到 Redis Broker
3. 任务提交失败但未报错

## 解决方案

### 1. 诊断 Celery Worker 状态

运行诊断命令检查 Celery Worker 状态：

```bash
python 测试审查.py --diagnose
```

诊断功能会检查：
- ✅ Redis 连接状态
- ✅ Celery 应用配置
- ✅ Celery Worker 是否运行
- ✅ 注册的任务列表

**示例输出：**
```
============================================================
Celery Worker 诊断
============================================================

1. 检查 Redis 连接...
   ✅ Redis 连接正常
   Redis URL: localhost:6379

2. 检查 Celery 应用配置...
   ✅ Celery 应用加载成功
   Broker URL: redis://localhost:6379/0
   Backend URL: redis://localhost:6379/0
   Worker Pool: solo

3. 检查 Celery Worker 状态...
   ✅ Celery Worker 可用
   活跃 Worker 数量: 1
   注册的任务数量: 15
   已注册的任务:
     - app.worker.ai_review_tasks.run_ai_review_task
     - app.worker.review_tasks.run_rule_review_task
     ...
```

### 2. 直接执行模式（不使用 Celery）

如果 Celery Worker 不可用，可以使用 `--direct` 参数直接执行审查任务（同步执行）：

```bash
python 测试审查.py <version_id> RULE --direct
```

**特点：**
- ✅ 不需要 Celery Worker
- ✅ 同步执行，立即看到结果
- ✅ 适合测试和调试
- ⚠️ 阻塞式执行（任务完成前脚本不会退出）

**示例：**
```bash
# 直接执行规则审查
python 测试审查.py 10 RULE --direct --show-results

# 直接执行AI审查
python 测试审查.py 10 AI --direct --show-results

# 直接执行混合审查
python 测试审查.py 10 MIXED --direct --show-results
```

### 3. 自动检测模式

如果不指定 `--direct`，脚本会自动检测 Celery Worker 状态：

- **Worker 可用**：使用 Celery 异步执行
- **Worker 不可用**：提示错误，建议使用 `--direct` 参数

## 使用场景

### 场景1：开发调试

**推荐使用直接执行模式：**
```bash
python 测试审查.py 10 RULE --direct --show-results
```

优点：
- 不需要启动 Celery Worker
- 立即看到执行结果和错误信息
- 方便调试和测试

### 场景2：生产环境

**推荐使用 Celery 异步执行：**
```bash
# 1. 启动 Celery Worker
celery -A app.worker.app worker --pool=solo --loglevel=info

# 2. 在另一个终端触发审查
python 测试审查.py 10 RULE --show-results
```

优点：
- 异步执行，不阻塞
- 支持任务队列和并发
- 适合生产环境

### 场景3：排查问题

**先诊断，再决定执行方式：**
```bash
# 1. 诊断 Celery Worker 状态
python 测试审查.py --diagnose

# 2. 根据诊断结果选择执行方式
# 如果 Worker 可用，使用异步模式
python 测试审查.py 10 RULE

# 如果 Worker 不可用，使用直接执行模式
python 测试审查.py 10 RULE --direct
```

## 参数说明

### 基本参数

- `version_id`: 版本ID（必需）
- `run_type`: 审查类型，可选值：`RULE`、`AI`、`MIXED`（默认：`RULE`）

### 执行模式参数

- `--direct`: 直接执行（不使用Celery，同步执行）
- `--diagnose`: 诊断 Celery Worker 状态并退出

### 监控参数

- `--no-monitor`: 不监控进度（仅触发任务）
- `--poll-interval <秒>`: 进度轮询间隔（默认：2秒）
- `--max-wait <秒>`: 最大等待时间（默认：300秒）

### 输出参数

- `--show-results`: 审查完成后显示结果

## 完整示例

```bash
# 1. 诊断 Celery Worker
python 测试审查.py --diagnose

# 2. 直接执行规则审查（同步）
python 测试审查.py 10 RULE --direct --show-results

# 3. 直接执行AI审查（同步）
python 测试审查.py 10 AI --direct --show-results

# 4. 异步执行规则审查（需要 Celery Worker）
python 测试审查.py 10 RULE --show-results

# 5. 异步执行混合审查，不监控进度
python 测试审查.py 10 MIXED --no-monitor
```

## 常见问题

### Q1: 任务一直处于 PENDING 状态

**原因：** Celery Worker 未运行或无法连接

**解决方案：**
1. 运行诊断：`python 测试审查.py --diagnose`
2. 如果 Worker 不可用，使用 `--direct` 参数直接执行
3. 或启动 Celery Worker：`celery -A app.worker.app worker --pool=solo`

### Q2: 直接执行模式会阻塞吗？

**答：** 是的，直接执行模式是同步的，会阻塞直到任务完成。适合测试和调试，不适合生产环境。

### Q3: 如何查看审查结果？

**方法1：** 使用 `--show-results` 参数
```bash
python 测试审查.py 10 RULE --direct --show-results
```

**方法2：** 使用 API
```bash
GET /api/versions/10/issues
GET /api/review-runs/{run_id}
```

### Q4: 直接执行模式和异步执行模式有什么区别？

| 特性 | 直接执行模式 | 异步执行模式 |
|------|------------|------------|
| 需要 Celery Worker | ❌ 不需要 | ✅ 需要 |
| 执行方式 | 同步（阻塞） | 异步（非阻塞） |
| 适合场景 | 测试、调试 | 生产环境 |
| 任务队列 | ❌ 不支持 | ✅ 支持 |
| 并发执行 | ❌ 不支持 | ✅ 支持 |

## 技术实现

### 核心逻辑提取

审查任务的核心逻辑已提取到独立函数：

- `_execute_rule_review()`: 规则审查核心逻辑
- `_execute_ai_review()`: AI审查核心逻辑

这些函数不依赖 Celery 装饰器，可以直接调用。

### Celery 任务包装

Celery 任务现在只是包装器：

```python
@app.task(bind=True)
def run_rule_review_task(self, version_id: int, run_id: int):
    """Celery任务包装器"""
    _execute_rule_review(version_id, run_id, publish_events=True)
```

这样既支持 Celery 异步执行，也支持直接同步执行。
