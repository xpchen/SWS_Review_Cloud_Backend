# 路由注册问题诊断

## 问题现象

Swagger UI (`/docs`) 只显示了几个接口：
- GET /health
- GET /api/versions/{version_id}/pdf
- GET /api/versions/{version_id}/outline
- GET /api/versions/{version_id}/issues

**缺少的接口：**
- POST /api/auth/login ❌
- GET /api/auth/me ❌
- POST /api/projects ❌
- GET /api/projects ❌
- 其他所有接口 ❌

## 可能的原因

### 1. 服务启动时路由注册失败（最可能）

**检查方法：**
1. 查看服务启动日志，是否有导入错误
2. 运行测试脚本：`python check_routes.py`
3. 运行导入测试：`python test_imports.py`

**常见错误：**
- `ImportError: cannot import name 'export_router'` - 已修复，但需要重启服务
- `ModuleNotFoundError` - 依赖未安装
- `AttributeError` - 模块结构问题

### 2. 路由注册顺序问题

检查 `app/main.py` 中路由注册顺序，确保所有路由都在注册。

### 3. FastAPI OpenAPI 配置问题

检查是否有 `app.openapi()` 或 `app.openapi_schema` 的自定义配置。

### 4. 服务未完全重启

即使代码已修复，如果服务没有重启，旧代码仍在运行。

## 诊断步骤

### 步骤1：检查服务启动日志

查看启动时的完整日志，寻找：
- `ImportError`
- `ModuleNotFoundError`
- `AttributeError`
- 任何异常堆栈

### 步骤2：运行路由检查脚本

```bash
cd SWS_Review_Cloud_Backend_MVP
python check_routes.py
```

这会列出所有已注册的路由。

### 步骤3：运行导入测试

```bash
python test_imports.py
```

这会测试所有路由模块是否能正常导入。

### 步骤4：直接测试登录接口

即使Swagger UI不显示，接口可能仍然存在：

```bash
# 使用curl或Postman测试
POST http://localhost:8000/api/auth/login
Content-Type: application/json

{
  "username": "test",
  "password": "test"
}
```

### 步骤5：检查OpenAPI JSON

访问 `http://localhost:8000/openapi.json`，查看完整的API定义：
- 搜索 `/api/auth/login`
- 检查是否有 `paths` 对象
- 查看是否有错误信息

## 快速修复

### 1. 完全重启服务

```bash
# 停止服务（Ctrl+C）
# 重新启动
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 2. 检查启动日志

启动时应该看到类似输出：
```
INFO:     Started server process [12345]
INFO:     Application startup complete.
```

**如果没有看到这些，说明启动失败，需要查看错误信息。**

### 3. 验证路由注册

在 `app/main.py` 的 `app.include_router()` 之后添加：

```python
# 调试：打印所有路由
print("=" * 60)
print("已注册的路由:")
for route in app.routes:
    if hasattr(route, 'path') and hasattr(route, 'methods'):
        for method in route.methods:
            if method != 'HEAD':
                print(f"  {method:6s} {route.path}")
print("=" * 60)
```

重启服务后，查看控制台输出，确认所有路由都已注册。

## 预期结果

正常情况下，应该看到以下路由：

**认证 (auth):**
- POST /api/auth/login
- GET /api/auth/me

**项目 (projects):**
- POST /api/projects
- GET /api/projects
- GET /api/projects/{project_id}

**文档 (documents):**
- POST /api/projects/{project_id}/documents
- GET /api/projects/{project_id}/documents
- GET /api/documents/{document_id}
- GET /api/documents/{document_id}/versions
- POST /api/documents/{document_id}/versions/upload

**版本 (versions):**
- GET /api/versions/{version_id}/status
- GET /api/versions/{version_id}/pdf
- GET /api/versions/{version_id}/outline
- GET /api/versions/{version_id}/issues

**审查运行 (review-runs):**
- POST /api/versions/{version_id}/review-runs
- GET /api/review-runs/{run_id}
- GET /api/review-runs/{run_id}/events

**问题 (issues):**
- GET /api/issues/{issue_id}
- POST /api/issues/{issue_id}/actions

**知识库 (kb):**
- POST /api/kb/sources/upload
- GET /api/kb/sources
- POST /api/kb/sources/{source_id}/reindex

**导出 (export):**
- POST /api/versions/{version_id}/export

**系统:**
- GET /health
- GET /storage/{path:path}

## 如果仍然只有几个接口

1. **检查服务是否真的在运行最新代码**
   - 确认文件已保存
   - 确认服务已重启
   - 检查是否有多个Python进程

2. **检查是否有缓存问题**
   - 清除 `__pycache__` 目录
   - 重启服务

3. **检查依赖是否完整**
   ```bash
   pip install -r requirements.txt
   ```

4. **检查Python路径**
   - 确认 `PYTHONPATH` 包含项目根目录
   - 确认虚拟环境已激活
