# 测试文档处理说明

## 概述

`测试文档处理.py` 脚本允许你单独运行 Word 文档的处理流程，无需通过 API 上传。这对于调试和测试非常有用。

## 使用方法

### 方式1：上传并处理新文档

```bash
python 测试文档处理.py <文档ID> <文件路径>
```

**示例**：
```bash
python 测试文档处理.py 1 D:\test.docx
```

这会：
1. 上传文件到指定文档
2. 创建新版本
3. 执行完整的处理流程（7个步骤）

### 方式2：处理已存在的版本

```bash
python 测试文档处理.py --version-id <版本ID>
```

**示例**：
```bash
python 测试文档处理.py --version-id 5
```

这会：
1. 查找指定版本
2. 直接执行处理流程（跳过上传）

### 方式3：列出所有文档

```bash
python 测试文档处理.py --list-documents
```

这会列出所有文档及其ID，方便你找到要使用的文档ID。

## 处理步骤

脚本会按顺序执行以下7个步骤：

1. **DOCX转PDF** (进度: 10%)
   - 使用 LibreOffice 将 DOCX 转换为 PDF

2. **解析DOCX结构** (进度: 25%)
   - 解析标题、段落、表格
   - 生成文档结构

3. **提取PDF布局** (进度: 40%)
   - 提取PDF每页的布局信息

4. **对齐块到PDF** (进度: 55%)
   - 将文档块对齐到PDF页面位置

5. **抽取事实** (进度: 70%)
   - 从文档中抽取结构化事实

6. **构建块和索引** (进度: 85%)
   - 构建RAG索引（MVP暂未实现）

7. **完成处理** (进度: 100%)
   - 设置版本状态为 READY

## 输出示例

```
============================================================
测试：上传并处理 Word 文档
============================================================
文档ID: 1
文件路径: D:\test.docx

📄 读取文件...
   文件大小: 123,456 字节 (0.12 MB)
   文件名: test.docx

📤 上传文件...
✅ 上传成功
   版本ID: 10
   版本号: 1

============================================================
测试：处理文档版本
============================================================
版本ID: 10

版本信息:
   文档ID: 1
   版本号: 1
   状态: UPLOADED

🔄 更新状态为 PROCESSING...
✅ 状态已更新

📋 步骤: DOCX转PDF (进度: 10%)
------------------------------------------------------------
[版本 10] 步骤: DOCX转PDF - 开始下载源文件
[版本 10] 步骤: DOCX转PDF - 源文件大小: 123456 字节
✅ DOCX转PDF 完成

📋 步骤: 解析DOCX结构 (进度: 25%)
------------------------------------------------------------
[版本 10] 步骤: 解析DOCX结构 - 开始
[版本 10] 解析DOCX结构: 50/150 (33%) - 已处理 50/150 个项目
✅ 解析DOCX结构 完成

...

============================================================
✅ 所有步骤完成！
============================================================
最终状态: READY
最终进度: 100%
当前步骤: 已完成
```

## 错误处理

如果某个步骤失败：

1. **错误信息**：会显示详细的错误信息和堆栈跟踪
2. **状态更新**：版本状态会更新为 `FAILED`
3. **错误消息**：错误消息会保存到数据库

**示例**：
```
📋 步骤: DOCX转PDF (进度: 10%)
------------------------------------------------------------
❌ DOCX转PDF 失败: LibreOffice (soffice) not found
Traceback (most recent call last):
  ...
```

## 中断处理

按 `Ctrl+C` 可以中断处理：

```
⚠️  用户中断处理
```

版本状态会更新为 `FAILED`，错误消息为 "用户中断"。

## 前置条件

1. **数据库连接**：确保 `.env` 文件中的数据库配置正确
2. **Redis**：如果使用 Celery，需要 Redis 运行（但此脚本不使用 Celery）
3. **LibreOffice**：需要安装 LibreOffice 用于 DOCX 转 PDF
4. **文档存在**：如果要处理已存在的版本，确保版本ID存在

## 注意事项

1. **不使用 Celery**：此脚本直接调用 pipeline 函数，不使用 Celery Worker
2. **同步执行**：所有步骤都是同步执行的，会阻塞直到完成
3. **详细输出**：所有处理步骤的日志都会输出到控制台
4. **状态更新**：每个步骤都会更新数据库中的版本状态和进度

## 常见问题

### Q: 如何找到文档ID？

A: 使用 `--list-documents` 参数列出所有文档，或者通过 API 查询。

### Q: 可以处理多个文件吗？

A: 可以，但需要分别运行脚本。或者修改脚本添加批量处理功能。

### Q: 处理失败后可以重新处理吗？

A: 可以，使用 `--version-id` 参数重新处理失败的版本。

### Q: 这个脚本和通过 API 上传有什么区别？

A: 
- **API 上传**：使用 Celery 异步处理，不阻塞
- **此脚本**：同步处理，适合调试和测试

### Q: 可以只执行某个步骤吗？

A: 可以修改脚本，注释掉不需要的步骤，或者添加 `--step` 参数。

## 调试技巧

1. **查看详细日志**：所有步骤都会输出详细日志
2. **检查数据库**：处理过程中可以查询数据库查看状态
3. **单步执行**：可以修改脚本，只执行某个步骤进行调试
4. **使用断点**：在 VS Code/VS2022 中设置断点进行调试
