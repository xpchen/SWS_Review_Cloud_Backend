# VS2022 调试 FastAPI 项目指南

## 方法一：使用 VS2022 内置 Python 调试器（推荐）

### 1. 确保已安装 Python 工作负载

在 VS2022 中：
1. 打开 **工具** → **获取工具和功能**
2. 确保已安装 **"Python 开发"** 工作负载
3. 如果没有，勾选并安装

### 2. 配置 Python 环境

1. 打开项目后，VS2022 会自动检测 Python 环境
2. 如果没有检测到，手动设置：
   - **解决方案资源管理器** → 右键项目 → **属性**
   - **调试** → **启动设置**
   - 选择 Python 解释器（建议使用虚拟环境）

### 3. 创建启动配置文件

**方法A：使用项目属性配置（推荐）**

1. 右键项目 → **属性**
2. 选择 **调试** → **常规**
3. 配置如下：
   - **启动模式**: 模块
   - **模块名称**: `uvicorn`
   - **参数**: `app.main:app --reload --host 0.0.0.0 --port 8000`
   - **工作目录**: `$(ProjectDir)`
   - **环境变量**: 
     ```
     PYTHONPATH=$(ProjectDir)
     ```

**方法B：使用 launchSettings.json**

在项目根目录创建 `Properties/launchSettings.json`：

```json
{
  "profiles": {
    "FastAPI": {
      "commandName": "Executable",
      "executablePath": "${env:VIRTUAL_ENV}\\Scripts\\python.exe",
      "commandLineArgs": "-m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000",
      "workingDirectory": "${workspaceFolder}",
      "environmentVariables": {
        "PYTHONPATH": "${workspaceFolder}"
      }
    }
  }
}
```

### 4. 设置断点并启动调试

1. 在代码中设置断点（点击行号左侧）
2. 按 **F5** 或点击 **调试** → **开始调试**
3. 服务启动后，访问 `http://localhost:8000/health` 触发断点

## 方法二：使用 VS Code 扩展（如果安装了 VS Code 扩展）

VS2022 支持 `.vscode/launch.json` 配置：

1. 项目根目录已创建 `.vscode/launch.json`
2. 按 **F5** 启动调试
3. 选择配置："Python: FastAPI (API Server)"

## 方法三：附加到进程（Attach to Process）

如果服务已经在运行，可以附加调试器：

1. **调试** → **附加到进程**
2. 选择 `python.exe` 进程
3. 选择 **Python** 作为连接类型
4. 点击 **附加**

## 调试配置说明

### 主要配置项

| 配置项 | 说明 | 示例值 |
|--------|------|--------|
| **模块名称** | 要运行的 Python 模块 | `uvicorn` |
| **参数** | 命令行参数 | `app.main:app --reload --host 0.0.0.0 --port 8000` |
| **工作目录** | 项目根目录 | `$(ProjectDir)` |
| **环境变量** | Python路径等 | `PYTHONPATH=$(ProjectDir)` |

### 常用调试快捷键

| 快捷键 | 功能 |
|--------|------|
| **F5** | 开始调试 |
| **F9** | 切换断点 |
| **F10** | 单步跳过（Step Over） |
| **F11** | 单步进入（Step Into） |
| **Shift+F11** | 单步跳出（Step Out） |
| **Shift+F5** | 停止调试 |
| **Ctrl+Shift+F5** | 重启调试 |

## 调试技巧

### 1. 条件断点

右键断点 → **条件** → 设置条件表达式，例如：
```python
version_id == 1
```

### 2. 监视窗口

**调试** → **窗口** → **监视**，添加要监视的变量：
- `version_id`
- `context.outline_index`
- `drafts`

### 3. 即时窗口

**调试** → **窗口** → **即时**，可以执行 Python 表达式：
```python
len(context.blocks_by_id)
context.facts.keys()
```

### 4. 调用堆栈

**调试** → **窗口** → **调用堆栈**，查看函数调用链

### 5. 异常断点

**调试** → **窗口** → **异常设置**，勾选 **Python 异常**，可以在异常发生时自动中断

## 调试 Celery Worker

如果需要调试 Celery 任务：

1. 创建新的启动配置：
   - **模块名称**: `celery`
   - **参数**: `-A app.worker.app worker --loglevel=info`

2. 或者使用已创建的配置："Python: Celery Worker"

## 常见问题

### Q: 断点不生效（显示空心圆圈）

**原因：**
- Python 解释器路径不正确
- 代码路径不匹配

**解决：**
1. 检查 **调试** → **窗口** → **模块**，确认模块已加载
2. 确认工作目录设置正确
3. 确认 `PYTHONPATH` 环境变量包含项目根目录

### Q: 无法连接到数据库

**原因：**
- `.env` 文件未加载
- 环境变量未设置

**解决：**
1. 确认 `.env` 文件在项目根目录
2. 在启动配置中添加环境变量：
   ```
   DATABASE_URL=postgresql://sws_app:root@localhost:5432/sws_review_cloud
   DB_SCHEMA=sws
   ```

### Q: 导入错误（ImportError）

**原因：**
- `PYTHONPATH` 未设置
- 虚拟环境未激活

**解决：**
1. 在启动配置中设置 `PYTHONPATH=$(ProjectDir)`
2. 确认使用虚拟环境的 Python 解释器

### Q: 热重载不工作

**原因：**
- `--reload` 参数可能在某些调试模式下不工作

**解决：**
- 调试时可以不使用 `--reload`，手动重启调试
- 或使用 **Ctrl+Shift+F5** 快速重启

## 推荐调试流程

1. **设置断点**：在关键函数入口设置断点
   - `app/routers/auth.py` 的 `login()` 函数
   - `app/services/checkpoint_runner.py` 的 `build_context()` 函数
   - `app/rule_engine/format_review.py` 的各个 check 函数

2. **启动调试**：按 F5

3. **触发请求**：使用 Postman 或浏览器访问 API

4. **查看变量**：在监视窗口查看变量值

5. **单步调试**：使用 F10/F11 逐步执行

6. **查看日志**：在输出窗口查看应用日志

## 示例：调试登录接口

1. 在 `app/routers/auth.py` 的 `login()` 函数第一行设置断点
2. 按 F5 启动调试
3. 在 Postman 中发送 POST 请求到 `http://localhost:8000/api/auth/login`
4. 程序会在断点处暂停
5. 在监视窗口查看 `body.username` 和 `body.password`
6. 使用 F10 单步执行，观察 `user` 变量的值
7. 继续执行，查看返回结果

## 环境变量配置

在启动配置中添加所有必要的环境变量：

```
DATABASE_URL=postgresql://sws_app:root@localhost:5432/sws_review_cloud
DB_SCHEMA=sws
BASE_URL=http://localhost:8000
REDIS_URL=redis://:root@localhost:6379/0
CELERY_BROKER_URL=redis://:root@localhost:6379/1
STORAGE_TYPE=local
LOCAL_STORAGE_DIR=storage_data
MINIO_ENDPOINT=localhost:9000
MINIO_ACCESS_KEY=admin
MINIO_SECRET_KEY=jskjmi666999
MINIO_BUCKET=sws
JWT_SECRET=change-me-in-production
JWT_ACCESS_EXPIRE_MINUTES=30
JWT_REFRESH_EXPIRE_DAYS=7
QWEN_API_KEY=sk-9cddb48385ad467b8e9947fc6a9ecb2a
QWEN_MODEL=qwen-plus
PYTHONPATH=${workspaceFolder}
```

## 快速开始

1. 打开 VS2022
2. 打开项目 `SWS_Review_Cloud_Backend_MVP.sln`
3. 在 `app/routers/auth.py` 的 `login()` 函数设置断点
4. 按 **F5** 启动调试
5. 使用 Postman 调用登录接口
6. 开始调试！
