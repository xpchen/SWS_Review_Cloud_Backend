# 自动触发审查功能说明

## 功能概述

版本结构化处理完成后，系统会自动触发规则审查，无需手动操作。

## 工作流程

1. **文档上传** → 触发处理管道
2. **结构化处理** → 7个步骤依次执行：
   - DOCX转PDF
   - 解析DOCX结构
   - 提取PDF布局
   - 对齐块到PDF
   - 抽取事实
   - 构建块和索引
   - **完成处理** ← 在这里自动触发审查
3. **自动触发规则审查** → 创建审查运行并执行规则审查
4. **审查完成** → 生成审查结果

## 配置选项

在 `.env` 文件中可以配置是否自动触发审查：

```env
# 版本处理完成后是否自动触发规则审查（默认: true）
AUTO_TRIGGER_REVIEW=true
```

### 启用自动审查（默认）
```env
AUTO_TRIGGER_REVIEW=true
```

### 禁用自动审查
```env
AUTO_TRIGGER_REVIEW=false
```

如果禁用自动审查，版本处理完成后不会自动触发审查，需要手动通过 API 或测试脚本触发。

## 执行方式

系统会根据 Celery Worker 的可用性自动选择执行方式：

### 1. Celery 异步执行（推荐）
- 如果 Celery Worker 正在运行
- 审查任务会提交到 Celery 队列异步执行
- 不会阻塞版本处理流程

### 2. 直接执行（同步）
- 如果 Celery Worker 不可用
- 审查任务会直接同步执行
- 会阻塞版本处理流程，但确保审查能够执行

## 日志输出

自动触发审查时，会在日志中输出以下信息：

```
[版本 {version_id}] 已创建审查运行，运行ID: {run_id}
[版本 {version_id}] 规则审查任务已提交到 Celery
```

或（如果 Celery 不可用）：

```
[版本 {version_id}] Celery Worker 不可用，使用直接执行模式
[版本 {version_id}] 规则审查任务已完成（直接执行）
```

## 错误处理

如果自动触发审查失败：
- **不会影响版本状态**：版本仍然会标记为 `READY`
- **记录错误日志**：错误信息会记录在日志中
- **可以手动触发**：后续可以通过 API 手动触发审查

错误日志示例：
```
[版本 {version_id}] 自动触发规则审查失败: {error_message}
```

## 手动触发审查

即使启用了自动审查，也可以手动触发审查：

### 通过 API
```bash
POST /api/review-runs
{
  "version_id": 1,
  "run_type": "RULE"
}
```

### 通过测试脚本
```bash
python 测试审查.py 1 RULE --direct
```

## 注意事项

1. **Celery Worker 状态**：
   - 如果 Celery Worker 未运行，会自动降级为直接执行模式
   - 建议在生产环境中保持 Celery Worker 运行

2. **审查类型**：
   - 当前自动触发的是 **规则审查（RULE）**
   - AI 审查需要手动触发

3. **性能影响**：
   - 使用 Celery 异步执行时，不会影响版本处理性能
   - 使用直接执行时，会稍微延长版本处理时间

4. **审查结果**：
   - 审查结果会保存在 `review_issue` 表中
   - 可以通过 API 查询审查结果

## 相关文件

- `app/worker/pipeline.py` - 版本处理管道，包含自动触发逻辑
- `app/worker/review_tasks.py` - 审查任务执行逻辑
- `app/settings.py` - 配置选项定义
- `app/services/review_run_service.py` - 审查运行服务

## 更新历史

- **2026-02-01**: 添加自动触发审查功能
  - 版本处理完成后自动触发规则审查
  - 添加配置选项 `AUTO_TRIGGER_REVIEW`
  - 支持 Celery 异步执行和直接执行两种模式
