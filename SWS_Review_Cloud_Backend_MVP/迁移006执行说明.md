# 迁移006执行说明

## 问题描述

当运行审查任务时，如果遇到以下错误：
```
psycopg.errors.UndefinedColumn: 字段 "review_category" 不存在
```

说明数据库还没有执行迁移006，缺少新添加的字段。

## 解决方案

### 方案1：执行迁移（推荐）

执行迁移以添加新字段，获得完整功能：

```bash
# 方法1：使用批处理脚本（Windows）
执行迁移006.bat

# 方法2：直接运行Python脚本
python 执行迁移006.py
```

迁移会添加以下字段：
- `review_checkpoint.engine_type` - 执行引擎类型（RULE/AI/SQL）
- `review_checkpoint.review_category` - 审查类别（FORMAT/CONTENT/CONSISTENCY等）
- `review_issue.checkpoint_code` - 审查点代码（如果不存在）

### 方案2：使用兼容模式（临时方案）

代码已经添加了向后兼容支持，即使不执行迁移也能运行，但会：
- ⚠️ 使用旧的 `category` 字段代替 `review_category` 和 `engine_type`
- ⚠️ 功能可能受限
- ⚠️ 控制台会显示警告信息

**建议：尽快执行迁移以获得完整功能**

## 迁移内容

迁移006 (`docs/migrations/006_checkpoint_schema_refactor.sql`) 会：

1. **添加新字段**
   - `review_checkpoint.engine_type` - 执行引擎类型
   - `review_checkpoint.review_category` - 审查类别
   - `review_issue.checkpoint_code` - 审查点代码（如果不存在）

2. **数据迁移**
   - 从现有 `category` 字段推断 `engine_type` 和 `review_category`
   - `category='AI'` → `engine_type='AI'`
   - 其他 → `engine_type='RULE'`

3. **创建索引**
   - `idx_review_checkpoint_engine_type` - 加速按引擎类型查询
   - `idx_review_checkpoint_category` - 加速按类别查询
   - `idx_review_issue_checkpoint` - 加速按审查点查询

## 验证迁移

迁移执行后，可以运行以下SQL验证：

```sql
-- 检查字段是否存在
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_schema = 'sws' 
AND table_name = 'review_checkpoint'
AND column_name IN ('engine_type', 'review_category');

-- 检查数据是否正确迁移
SELECT code, category, engine_type, review_category 
FROM sws.review_checkpoint 
LIMIT 10;
```

## 常见问题

### Q1: 迁移执行失败怎么办？

**可能原因：**
- 数据库连接失败
- SQL语法错误
- 字段已存在（可以忽略）

**解决方法：**
1. 检查数据库连接配置（`.env` 文件）
2. 查看错误信息，如果是"字段已存在"可以忽略
3. 手动执行SQL文件：`docs/migrations/006_checkpoint_schema_refactor.sql`

### Q2: 迁移后还需要做什么？

迁移执行完成后：
1. ✅ 重新运行审查任务
2. ✅ 验证功能是否正常
3. ✅ 检查是否有警告信息

### Q3: 不执行迁移可以吗？

可以，代码已添加向后兼容支持，但：
- ⚠️ 功能受限
- ⚠️ 性能可能受影响
- ⚠️ 无法使用新功能

**强烈建议执行迁移**

## 相关文件

- 迁移SQL文件：`docs/migrations/006_checkpoint_schema_refactor.sql`
- 执行脚本：`执行迁移006.py`
- 批处理脚本：`执行迁移006.bat`
