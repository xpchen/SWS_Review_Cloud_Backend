# 任务进度输出说明

## 概述

现在系统会在控制台输出详细的任务处理进度信息，包括：
- 每个任务的开始和结束状态
- 进度百分比（0-100%）
- 当前处理步骤的详细描述
- 处理过程中的关键信息（如文件大小、处理数量等）

## 功能特性

### 1. 任务级别进度

每个 Celery 任务都会输出：
- 任务开始日志：`[版本 {version_id}] 开始任务: {任务名称}`
- 任务完成日志：`[版本 {version_id}] 完成任务: {任务名称}`
- 任务失败日志：`[版本 {version_id}] {任务名称}失败: {错误信息}`

### 2. 步骤级别进度

每个处理步骤都会输出：
- 步骤描述：`[版本 {version_id}] 步骤: {步骤名称} - {详细信息}`
- 进度百分比：`[版本 {version_id}] {步骤名称}: {当前}/{总数} ({百分比}%)`

### 3. 数据库状态更新

版本状态会实时更新到数据库，包括：
- `status`: 当前状态（PROCESSING, READY, FAILED等）
- `progress`: 进度百分比（0-100）
- `current_step`: 当前步骤描述

## 任务流程

完整的处理流程包含7个步骤：

1. **DOCX转PDF** (进度: 10%)
   - 下载源文件
   - 使用LibreOffice转换
   - 上传PDF文件

2. **解析DOCX结构** (进度: 25%)
   - 清理旧数据
   - 解析标题、段落、表格
   - 生成结构JSON文件

3. **提取PDF布局** (进度: 40%)
   - 加载PDF文件
   - 提取每页布局信息
   - 保存布局JSON文件

4. **对齐块到PDF** (进度: 55%)
   - 加载文档块
   - 在PDF中搜索块位置
   - 生成锚点映射

5. **抽取事实** (进度: 70%)
   - 从文档中抽取结构化事实
   - 保存到FactStore

6. **构建块和索引** (进度: 85%)
   - 构建RAG索引（MVP暂未实现）

7. **完成处理** (进度: 100%)
   - 设置版本状态为READY

## 查看进度输出

### 方式1: Celery Worker 控制台

启动 Celery Worker 后，所有进度信息会输出到控制台：

```bash
celery -A app.worker.app worker --loglevel=info
```

### 方式2: VS2022 调试输出

在 VS2022 中调试 Celery Worker 时：
1. 启动 "Celery Worker" 配置
2. 查看 **输出** 窗口（调试 → 窗口 → 输出）
3. 选择 **Python** 作为输出源

### 方式3: API 查询状态

通过 API 查询版本状态：

```bash
GET /api/versions/{version_id}/status
```

返回示例：
```json
{
  "code": "OK",
  "message": "success",
  "data": {
    "version_id": 1,
    "status": "PROCESSING",
    "progress": 55,
    "current_step": "对齐块到PDF",
    "can_cancel": true,
    "can_reprocess": false,
    "can_delete": false
  }
}
```

## 进度输出示例

```
[版本 1] 🚀 开始处理管道，共7个步骤
[版本 1] 状态更新: PROCESSING, 进度: 0%, 步骤: 初始化
[版本 1] 开始任务: DOCX转PDF
[版本 1] 步骤: DOCX转PDF - 开始下载源文件
[版本 1] 步骤: DOCX转PDF - 下载源文件: projects/1/documents/1/versions/1/source.docx
[版本 1] 步骤: DOCX转PDF - 源文件大小: 1234567 字节
[版本 1] 步骤: DOCX转PDF - 开始转换（使用LibreOffice）
[版本 1] 步骤: DOCX转PDF - 转换完成，PDF大小: 2345678 字节
[版本 1] 步骤: DOCX转PDF - 上传PDF到存储
[版本 1] 步骤: DOCX转PDF - ✅ 完成
[版本 1] 完成任务: DOCX转PDF
[版本 1] 开始任务: 解析DOCX结构
[版本 1] 步骤: 解析DOCX结构 - 开始
[版本 1] 步骤: 解析DOCX结构 - 清理旧数据
[版本 1] 步骤: 解析DOCX结构 - 加载DOCX文件
[版本 1] 步骤: 解析DOCX结构 - 开始解析文档结构
[版本 1] 步骤: 解析DOCX结构 - 共 150 个项目需要处理
[版本 1] 解析DOCX结构: 50/150 (33%) - 已处理 50/150 个项目
[版本 1] 解析DOCX结构: 100/150 (66%) - 已处理 100/150 个项目
[版本 1] 解析DOCX结构: 150/150 (100%) - 已处理 150/150 个项目
[版本 1] 解析DOCX结构: 完成，共解析 25 个标题节点，150 个块
[版本 1] 步骤: 解析DOCX结构 - 生成结构JSON文件
[版本 1] 步骤: 解析DOCX结构 - ✅ 完成
...
[版本 1] ✅ 所有任务完成，版本已就绪
```

## 配置说明

### 日志级别

确保 Celery Worker 使用 `info` 或更详细的日志级别：

```bash
celery -A app.worker.app worker --loglevel=info
```

### 环境变量

确保设置了 `PYTHONUNBUFFERED=1` 以实时输出日志：

```bash
export PYTHONUNBUFFERED=1
```

或在 VS2022 的启动配置中设置：
```json
{
  "environmentVariables": {
    "PYTHONUNBUFFERED": "1"
  }
}
```

## 注意事项

1. **进度更新频率**：为了性能考虑，进度更新不是每个项目都更新，而是：
   - 解析DOCX结构：每50个项目更新一次
   - 提取PDF布局：每10页更新一次
   - 对齐块到PDF：每50个块更新一次

2. **输出位置**：所有进度信息同时输出到：
   - Python logging（可通过日志系统查看）
   - stderr（确保在 Celery worker 控制台可见）

3. **数据库字段**：`progress` 和 `current_step` 字段需要数据库支持。如果数据库中没有这些字段，请运行迁移脚本添加它们。

## 故障排查

### 看不到进度输出

1. 检查 Celery Worker 是否正在运行
2. 检查日志级别是否设置为 `info` 或更高
3. 检查 `PYTHONUNBUFFERED` 环境变量是否设置

### 进度不更新

1. 检查数据库连接是否正常
2. 检查 `document_version` 表是否有 `progress` 和 `current_step` 字段
3. 查看 Celery Worker 的错误日志

### 进度显示不准确

进度百分比是基于任务步骤的估算值，实际处理时间可能因文档大小而异。
