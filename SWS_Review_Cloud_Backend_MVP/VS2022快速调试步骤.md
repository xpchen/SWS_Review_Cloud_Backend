# VS2022 快速调试步骤

## 最简单的方法（推荐）

### 步骤1：打开项目属性

1. 在 **解决方案资源管理器** 中，右键点击项目 `SWS_Review_Cloud_Backend_MVP`
2. 选择 **属性**（或按 `Alt+Enter`）

### 步骤2：配置启动设置

在 **调试** 标签页中配置：

#### 方式A：使用模块启动（推荐）

- **启动模式**: 选择 **模块**
- **模块名称**: 输入 `uvicorn`
- **参数**: 输入 `app.main:app --reload --host 0.0.0.0 --port 8000`
- **工作目录**: 选择 **项目目录** 或输入 `${ProjectDir}`
- **环境**: 点击 **环境变量** 按钮，添加：
  ```
  PYTHONPATH = $(ProjectDir)
  ```

#### 方式B：使用可执行文件

- **启动模式**: 选择 **可执行文件**
- **可执行文件路径**: 输入虚拟环境的 Python 路径，例如：
  ```
  C:\path\to\your\venv\Scripts\python.exe
  ```
  或使用环境变量：
  ```
  ${env:VIRTUAL_ENV}\Scripts\python.exe
  ```
- **参数**: 输入 `-m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000`
- **工作目录**: `${ProjectDir}`

### 步骤3：设置断点

1. 打开 `app/routers/auth.py`
2. 在 `login()` 函数的第一行（`def login(body: LoginRequest):` 下一行）点击左侧设置断点
3. 断点显示为红色实心圆

### 步骤4：开始调试

1. 按 **F5** 或点击工具栏的 **开始调试** 按钮
2. 等待服务启动（输出窗口会显示启动日志）
3. 看到类似以下日志表示启动成功：
   ```
   INFO:     Uvicorn running on http://0.0.0.0:8000
   INFO:     Application startup complete.
   ```

### 步骤5：触发断点

1. 打开 Postman 或浏览器
2. 发送 POST 请求到 `http://localhost:8000/api/auth/login`
3. 请求体：
   ```json
   {
     "username": "test",
     "password": "test"
   }
   ```
4. 程序会在断点处暂停

### 步骤6：调试操作

- **F10**: 单步跳过（执行下一行，不进入函数）
- **F11**: 单步进入（进入函数内部）
- **Shift+F11**: 单步跳出（跳出当前函数）
- **F5**: 继续执行（直到下一个断点）
- **Shift+F5**: 停止调试

### 步骤7：查看变量

- **监视窗口**: **调试** → **窗口** → **监视** → **监视1**
  - 添加变量：`body.username`, `body.password`, `user`
- **局部变量窗口**: **调试** → **窗口** → **局部变量**
  - 自动显示当前作用域的所有变量
- **即时窗口**: **调试** → **窗口** → **即时**
  - 可以执行 Python 表达式，例如：`len(context.blocks_by_id)`

## 配置环境变量

如果需要加载 `.env` 文件中的环境变量，在项目属性的 **调试** → **环境变量** 中添加：

```
DATABASE_URL=postgresql://sws_app:root@localhost:5432/sws_review_cloud
DB_SCHEMA=sws
BASE_URL=http://localhost:8000
REDIS_URL=redis://:root@localhost:6379/0
CELERY_BROKER_URL=redis://:root@localhost:6379/1
STORAGE_TYPE=local
LOCAL_STORAGE_DIR=storage_data
MINIO_ENDPOINT=localhost:9000
MINIO_ACCESS_KEY=admin
MINIO_SECRET_KEY=jskjmi666999
MINIO_BUCKET=sws
JWT_SECRET=change-me-in-production
JWT_ACCESS_EXPIRE_MINUTES=30
JWT_REFRESH_EXPIRE_DAYS=7
QWEN_API_KEY=sk-9cddb48385ad467b8e9947fc6a9ecb2a
QWEN_MODEL=qwen-plus
PYTHONPATH=$(ProjectDir)
```

## 调试多个进程

如果需要同时调试 API 服务器和 Celery Worker：

1. 右键解决方案 → **属性** → **启动项目**
2. 选择 **多个启动项目**
3. 为两个项目都设置为 **启动**
4. 分别为两个项目配置不同的启动设置

## 常见问题

### Q: 断点显示空心圆圈（未绑定）

**解决：**
1. 确认工作目录设置为 `${ProjectDir}`
2. 确认 `PYTHONPATH` 环境变量包含项目根目录
3. 确认使用的是项目虚拟环境的 Python 解释器

### Q: 无法找到模块 'app'

**解决：**
1. 在环境变量中添加 `PYTHONPATH=$(ProjectDir)`
2. 确认工作目录正确
3. 确认虚拟环境已激活

### Q: 服务启动但断点不触发

**解决：**
1. 确认代码路径与运行路径一致
2. 检查 **调试** → **窗口** → **模块**，确认模块已加载
3. 尝试在 `app/main.py` 的 `health()` 函数设置断点测试

### Q: 热重载不工作

**解决：**
- 调试模式下 `--reload` 可能不稳定
- 可以移除 `--reload` 参数，使用 **Ctrl+Shift+F5** 快速重启调试

## 调试技巧

### 1. 条件断点
右键断点 → **条件** → 输入条件，例如：
```python
version_id == 1 and len(drafts) > 0
```

### 2. 日志点（Logpoint）
右键断点 → **操作** → 勾选 **记录消息**，输入：
```
检查点 {checkpoint_code} 产生 {len(drafts)} 个问题
```
这样可以在不暂停执行的情况下输出日志

### 3. 异常断点
**调试** → **窗口** → **异常设置** → 展开 **Python 异常** → 勾选需要中断的异常类型

### 4. 调用堆栈
**调试** → **窗口** → **调用堆栈**，查看完整的函数调用链

## 示例：调试审查流程

1. 在 `app/services/checkpoint_runner.py` 的 `build_context()` 函数设置断点
2. 在 `app/rule_engine/format_review.py` 的 `run_format_review()` 函数设置断点
3. 在 `app/rule_engine/format_review.py` 的 `check_cover_required_elements()` 函数设置断点
4. 按 F5 启动调试
5. 触发审查任务（通过 API 调用）
6. 观察执行流程：
   - 首先在 `build_context()` 暂停，查看 `context` 对象
   - 然后在 `run_format_review()` 暂停，查看 `rule_config`
   - 最后在具体的 check 函数中查看检查逻辑

## 快捷键速查

| 快捷键 | 功能 |
|--------|------|
| **F5** | 开始/继续调试 |
| **F9** | 切换断点 |
| **F10** | 单步跳过 |
| **F11** | 单步进入 |
| **Shift+F11** | 单步跳出 |
| **Shift+F5** | 停止调试 |
| **Ctrl+Shift+F5** | 重启调试 |
| **Ctrl+Alt+Q** | 快速监视 |
