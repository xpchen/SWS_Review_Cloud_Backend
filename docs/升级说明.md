0. 你现在代码里，“立案”缺的是什么

你当前后端已有：

项目：/api/projects

文档：/api/projects/{project_id}/documents

版本上传：/api/documents/{document_id}/versions/upload

解析流水线：docx→pdf、解析大纲/段落/表格、页码映射（app/worker/pipeline.py）

规则审查（review run）：/api/versions/{version_id}/review-runs，执行 run_all_rules() 写入 review_issue

但目前 规则审查默认假设文档已可用。而“立案”要做的，是在进入“审查”之前先做 受理门槛校验：

元数据是否齐、附件是否齐、格式能否解析、关键章节是否存在、能否确定适用规则包（广东/非广东、报告类型、项目类型等）。

因此：立案规则库 = 一套 Gate / Intake 规则，输出的是“立案问题清单”（可以单独表，也可以复用 issue 表但需加 stage/type 区分）。

1) 立案规则库的输入：你必须先定义“立案事实（Facts）”

立案规则不要直接读 Word 正文做复杂判断（那是审查阶段），立案只需要这些事实源：

A. 项目/文档元数据（强依赖）

建议把以下字段放到一个 JSON（或拆表）里，后续规则选择全靠它：

行政区：省/市/县（至少省，用于“广东规则包”）

项目类型：交通/水利/市政/房地产/矿山…（用于选择审查要点规则包）

是否涉及敏感区：饮用水源保护区/自然保护区/地质灾害易发区等（用于提升等级、触发附加材料要求）

扰动面积、弃渣量、土石方量等关键规模指标（用于阈值规则、决定一些章节/表格是否必须出现）

立项/批复信息：是否已批、批复文号、批复日期（用于“未批先建/材料缺失”阻断）

你现有 ProjectCreate 只有 name/location，不足以支撑立案分流。立案规则库必须“先把元数据模型立起来”。

B. 文件与流水线状态（硬门槛）

document_version.status 是否 READY

source_file_id/pdf_file_id/structure_file_id/page_map_file_id 是否齐

docx→pdf 转换是否成功（你 pipeline 已写入 error_message）

C. 结构化产物（轻量结构校验）

doc_outline_node 数量、层级、是否能识别标题

doc_block 是否有足够的段落块

doc_table/doc_table_cell 是否存在关键表格（只做“有没有”，不做复杂算术）

注意：你的结构解析强依赖 Word 标题样式（只认 Heading 字样）。这会成为立案阶段最关键的一条规则：

如果标题样式不规范 → 大纲为空/错乱 → 后续所有规则都会误报/漏报。立案必须先挡住。

2) 立案规则库应该长什么样：规则包（Rule Pack）+ 规则（Rule）

我建议你把“规则库”拆成两层：

(1) 规则包 RulePack（用于“选用哪套规则”）

例如：

FIL_GD_BASE：广东通用立案规则

FIL_NAT_BASE：全国通用立案规则

FIL_WATERPOWER：水利水电类项目立案增强规则

FIL_ROAD：交通类项目立案增强规则

FIL_SENSITIVE_AREA：涉及敏感区附加材料规则

RulePack 要有 适用条件，例如：

省=广东 → 加载 FIL_GD_BASE

项目类型=水利水电 → 加载 FIL_WATERPOWER

meta.has_sensitive_area=true → 加载 FIL_SENSITIVE_AREA

(2) 规则 Rule（可配置、可复用、参数化）

立案规则的“规则类型”建议只做这几类（足够覆盖 80%）：

必填字段：缺字段就阻断/重要

附件必需：缺附件/缺批复扫描件/缺坐标范围图 → 阻断

流水线就绪：版本不是 READY、缺 structure/page_map → 阻断（或提示稍后重试）

结构最小可解析：大纲节点数<阈值 / 1级标题不存在 / 标题样式异常 → 阻断

章节/清单存在性：如“项目概况/水土保持措施/投资”等必备章节缺失 → 重要

元数据—文档一致性（轻量）：元数据填了“有弃渣场”，文档里完全没有弃渣相关章节/表格 → 重要

立案不建议做“合计校验/单位一致性”等深度内容（你现有 SUM_MISMATCH、UNIT_INCONSISTENT 更像审查阶段）。

3) 在你的源码里，规则库怎么落地最顺（不推翻重来）

你现在的 RULE_REGISTRY 是硬编码的。要做“立案规则库”，最稳的做法是 新增一个 intake 引擎，并且规则定义走“配置驱动”。

推荐目录结构（贴合你现有 rule_engine 风格）
app/
  rule_engine/
    intake/                 # 立案引擎（新增）
      __init__.py
      base.py               # IntakeIssueDraft / IntakeRuleContext
      required_fields.py
      required_attachments.py
      pipeline_ready.py
      heading_style_quality.py
      minimal_outline.py
      section_presence.py
  rulesets/
    intake/
      packs.yaml            # RulePack 列表 + 条件
      rules/
        F001_required_fields.yaml
        F010_pipeline_ready.yaml
        F020_heading_style.yaml
        ...

规则定义建议用 YAML/JSON（示例）
id: F020
name: "标题样式可解析性校验"
engine: HEADING_STYLE_QUALITY
severity: S1
when:
  doc_type: SOIL_WATER_PLAN
params:
  min_h1: 3
  require_heading_style: true
message:
  title: "文档标题样式不规范，无法可靠生成大纲"
  suggestion: "请将章/节标题改为Word内置“标题1/标题2/标题3(Heading 1/2/3)”，再重新上传。"

engine 字段如何对接你现有 Python

你现在是：

RULE_REGISTRY = {"SUM_MISMATCH": run_sum_mismatch, ...}


立案也做一个：

INTAKE_REGISTRY = {"HEADING_STYLE_QUALITY": run_heading_style_quality, ...}


但“规则有哪些、启用哪些、参数是什么”从 YAML/DB 读出来，而不是写死在代码里。

4) 立案规则库的“最小可用集（MVP）”我建议你先建这 12 条

按优先级从高到低（立案最怕的是“后面全跑不起来”）：

阻断类（S1）

版本流水线未就绪：document_version.status != READY

缺少 pdf_file_id 或 structure_file_id 或 page_map_file_id

标题样式不可解析：outline 节点数过低 / 1级标题为 0（你的解析只认 Heading）

项目元数据缺失：省、市、项目类型、建设地点（至少省+类型）

批复信息缺失（如果 meta.has_approval=true 但没有 approval_no/附件）

重要类（S2）

必备章节缺失（你现有 missing_section 可迁到 intake，做成可配置）

有“弃渣/取土”却没有弃渣相关章节/表格

有“临时占地”却无临时占地说明章节

文档标题/项目名称不一致（Project.name vs Document.title vs 文中封面提取到的名称）

提示类（S3）

大纲层级异常（全是一级/没有二级，影响定位）

表格为空或数字无法解析比例过高（提示格式问题）

PDF 页数异常（0页/1页但内容明显不完整）

5) 数据层建议：把“立案规则库”可运营起来

如果你希望后续“不同地区/不同项目类型”能不断加规则而不用发版，建议把规则库入库（PostgreSQL）：

最少三张表（概念）

rule_pack：规则包（id、name、when_condition_json、enabled）

rule_def：规则定义（id、engine、severity、params_json、message_tpl、enabled）

rule_pack_item：包与规则关联（pack_id、rule_id、order）

然后你在立案时：

根据 meta 计算要加载哪些 pack

汇总 rules

逐条执行 engine 对应的 Python 函数

写入 case_issue 或 review_issue(stage='INTAKE')

6) 结合你当前代码的一个关键提醒（立案必须做）

你现在的大纲解析逻辑 _get_heading_level/_heading_level_from_style 基本只识别 “Heading” 样式名；很多国内单位的 Word 模板用的是 “标题 1/标题 2/一、二、三自定义样式”，会导致：

doc_outline_node 少得可怜甚至为 0

missing_section 等规则大量误报

中间内容定位能力下降

所以：“标题样式可解析性校验”要作为立案第一大门槛，否则后续体验会非常差。