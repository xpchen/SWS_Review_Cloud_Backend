# 知识库完整导入指南

## 前置准备

### 1. 数据库准备

确保已执行以下迁移文件：

```bash
# 1. 基础表结构
psql -U sws_app -d sws_review_cloud -f docs/migrations/002_kb_tables.sql

# 2. pgvector扩展和embedding列
psql -U sws_app -d sws_review_cloud -f docs/migrations/005_add_pgvector_embedding.sql
```

**注意**：如果pgvector扩展安装失败，需要先安装：

```sql
-- Ubuntu/Debian
sudo apt-get install postgresql-15-pgvector  # 根据PostgreSQL版本调整

-- 或使用Docker
-- 在docker-compose.yml中添加pgvector镜像，或使用postgres:15-pgvector
```

### 2. 环境配置

确保 `.env` 文件配置正确：

```env
DATABASE_URL=postgresql://sws_app:root@localhost:5432/sws_review_cloud
DB_SCHEMA=sws
```

## 导入步骤

### 步骤1：执行数据库迁移

```bash
# 进入项目目录
cd SWS_Review_Cloud_Backend

# 执行迁移（如果还没执行）
psql -U sws_app -d sws_review_cloud -f docs/migrations/002_kb_tables.sql
psql -U sws_app -d sws_review_cloud -f docs/migrations/005_add_pgvector_embedding.sql
```

### 步骤2：运行导入脚本

```bash
# 进入知识库包目录
cd docs/kb_package_20260131_142514

# 方式A：直接运行（使用.env中的DATABASE_URL）
python import_to_db.py

# 方式B：指定参数
python import_to_db.py \
  --package_dir . \
  --storage LOCAL \
  --bucket kb

# 方式C：干运行（先查看会导入什么）
python import_to_db.py --dry_run
```

### 步骤3：验证导入结果

```bash
# 连接到数据库
psql -U sws_app -d sws_review_cloud

# 查询导入的知识库源
SELECT id, name, kb_type, status, 
       (SELECT COUNT(*) FROM sws.kb_chunk WHERE kb_source_id = kb_source.id) as chunk_count
FROM sws.kb_source
ORDER BY id;

# 查询chunks总数
SELECT COUNT(*) FROM sws.kb_chunk;

# 检查embedding列是否存在
\d sws.kb_chunk
```

## 导入脚本说明

### 脚本功能

`import_to_db.py` 会：

1. **读取配置**：
   - 从 `.env` 读取 `DATABASE_URL` 和 `DB_SCHEMA`
   - 或通过命令行参数指定

2. **处理每个source**：
   - 检查或创建 `file_object`（基于sha256去重）
   - 检查或创建 `kb_source`
   - 导入 `kb_chunk`（跳过重复）
   - 标记 `kb_source` 为 `READY`

3. **特殊处理**：
   - `IMAGE_ONLY` 文件：跳过chunks导入，但创建source记录
   - 重复chunks：基于hash自动跳过

### 导入输出示例

```
准备导入 10 个知识库源...
数据库schema: sws
存储类型: LOCAL, bucket: kb

处理: GB 51018-2014 水土保持工程设计规范 (2)
  文件: GB 51018-2014 水土保持工程设计规范 (2).pdf
  类型: NORM, 提取方法: TEXT
  ✓ 创建file_object: id=1
  ✓ 创建kb_source: id=1
  ✓ 完成: 导入942个chunks, 跳过0个重复chunks

处理: 《生产建设项目水土保持技术标准》（GB 50433-2018）
  文件: 《生产建设项目水土保持技术标准》（GB 50433-2018）.pdf
  类型: NORM, 提取方法: IMAGE_ONLY
  ⚠️  警告: 此文件为扫描件(IMAGE_ONLY)，需要先OCR
  跳过导入chunks（block_count=0）
  ✓ 创建file_object: id=2
  ✓ 创建kb_source: id=2

============================================================
导入完成!
  成功导入源: 10/10
  总chunks数: 1367
============================================================
```

## 后续步骤：生成Embedding（可选）

导入完成后，chunks的 `embedding` 列为 `NULL`。如果需要语义搜索，需要生成embedding：

### 方式1：使用API批量生成（推荐）

创建脚本 `generate_embeddings.py`：

```python
# 调用embedding API（如Qwen Embedding API）为所有chunks生成向量
# 然后UPDATE kb_chunk SET embedding = %s WHERE id = %s
```

### 方式2：使用pgvector的text2vec扩展

```sql
-- 如果使用pgvector的text2vec功能
UPDATE sws.kb_chunk 
SET embedding = text2vec(chunk_text)
WHERE embedding IS NULL;
```

## 故障排查

### 1. pgvector扩展安装失败

**错误**：`ERROR: extension "vector" does not exist`

**解决**：
```bash
# Ubuntu/Debian
sudo apt-get install postgresql-15-pgvector

# 或使用Docker镜像
# 在docker-compose.yml中使用：postgres:15-pgvector
```

### 2. 导入脚本找不到模块

**错误**：`ModuleNotFoundError: No module named 'app'`

**解决**：
```bash
# 确保在正确的目录运行
cd docs/kb_package_20260131_142514

# 或设置PYTHONPATH
export PYTHONPATH=/path/to/SWS_Review_Cloud_Backend_MVP:$PYTHONPATH
python import_to_db.py
```

### 3. 数据库连接失败

**错误**：`could not connect to server`

**解决**：
- 检查 `.env` 中的 `DATABASE_URL` 是否正确
- 检查PostgreSQL服务是否运行
- 检查用户权限

### 4. IMAGE_ONLY文件没有chunks

**说明**：这是正常的。`IMAGE_ONLY` 文件需要先OCR才能提取文本。

**处理**：
1. 使用OCR工具（如ocrmypdf）处理PDF
2. 重新生成知识库包
3. 或通过API上传OCR后的PDF

## 验证导入成功

导入完成后，可以通过以下方式验证：

### 1. 数据库查询

```sql
-- 查看所有知识库源
SELECT id, name, kb_type, status, 
       (SELECT COUNT(*) FROM sws.kb_chunk WHERE kb_source_id = kb_source.id) as chunks
FROM sws.kb_source
ORDER BY id;

-- 查看chunks详情
SELECT c.id, s.name, LEFT(c.chunk_text, 50) as preview, 
       c.meta_json->>'page_start' as page_start,
       c.embedding IS NOT NULL as has_embedding
FROM sws.kb_chunk c
JOIN sws.kb_source s ON s.id = c.kb_source_id
LIMIT 10;
```

### 2. API查询

```bash
# 查询所有知识库源
curl -X GET "http://localhost:8000/api/kb/sources" \
  -H "Authorization: Bearer <token>"
```

### 3. 测试RAG检索

导入后，AI审查会自动使用这些知识库：

```python
# 在ai_review_tasks.py中
norm_chunks = search_chunks("水土保持 规范", top_k=5)
# 会自动检索kb_chunk表
```

## 注意事项

1. **embedding列为NULL**：导入时embedding为NULL是正常的，后续可以批量生成
2. **IMAGE_ONLY文件**：这些文件需要先OCR，当前导入会跳过chunks
3. **重复导入**：脚本会自动跳过重复的chunks（基于hash），可以安全重复运行
4. **性能**：大量chunks导入可能需要几分钟，请耐心等待

## 下一步

导入完成后，可以：

1. **测试RAG检索**：运行AI审查，验证知识库是否被正确使用
2. **生成Embedding**：如果需要语义搜索，批量生成embedding向量
3. **优化索引**：根据实际使用情况调整ivfflat索引参数
