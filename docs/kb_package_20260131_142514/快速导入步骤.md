# 知识库快速导入步骤

## 第一步：执行数据库迁移

```bash
# 进入项目目录
cd SWS_Review_Cloud_Backend

# 执行迁移（添加embedding列）
psql -U sws_app -d sws_review_cloud -f docs/migrations/005_add_pgvector_embedding.sql
```

**如果pgvector扩展安装失败**：

```bash
# Ubuntu/Debian
sudo apt-get install postgresql-15-pgvector

# 或使用Docker镜像（推荐）
# 在docker-compose.yml中使用：postgres:15-pgvector
```

## 第二步：运行导入脚本

```bash
# 进入知识库包目录
cd docs/kb_package_20260131_142514

# 运行导入脚本
python import_to_db.py
```

**预期输出**：
```
准备导入 10 个知识库源...
数据库schema: sws
存储类型: LOCAL, bucket: kb

处理: GB 51018-2014 水土保持工程设计规范 (2)
  文件: GB 51018-2014 水土保持工程设计规范 (2).pdf
  类型: NORM, 提取方法: TEXT
  ✓ 创建file_object: id=1
  ✓ 创建kb_source: id=1
  ✓ 完成: 导入942个chunks, 跳过0个重复chunks

...

============================================================
导入完成!
  成功导入源: 10/10
  总chunks数: 1367
============================================================
```

## 第三步：验证导入

```sql
-- 连接到数据库
psql -U sws_app -d sws_review_cloud

-- 查看导入的知识库源
SELECT id, name, kb_type, status,
       (SELECT COUNT(*) FROM sws.kb_chunk WHERE kb_source_id = kb_source.id) as chunk_count
FROM sws.kb_source
ORDER BY id;

-- 检查embedding列
\d sws.kb_chunk

-- 查看chunks示例
SELECT id, LEFT(chunk_text, 100) as preview, 
       embedding IS NOT NULL as has_embedding
FROM sws.kb_chunk
LIMIT 5;
```

## 注意事项

1. **embedding列为NULL是正常的**：导入时embedding为NULL，后续可以批量生成
2. **IMAGE_ONLY文件**：7个扫描件文件会跳过chunks导入，但会创建source记录
3. **重复导入**：脚本会自动跳过重复的chunks，可以安全重复运行

## 常见问题

### Q: pgvector扩展安装失败怎么办？

A: 
- 确保PostgreSQL版本 >= 14
- 使用Docker镜像：`postgres:15-pgvector`
- 或手动编译安装pgvector扩展

### Q: 导入后embedding都是NULL？

A: 这是正常的。embedding需要后续批量生成，可以使用：
- Qwen Embedding API
- 或其他embedding服务

### Q: 如何生成embedding？

A: 后续可以创建脚本批量调用embedding API，然后UPDATE chunks。
