# 知识库导入说明

## 知识库包内容

- `kb_sources.json`: 知识库源文件清单（10个PDF文件）
- `kb_chunks.jsonl`: 已分块的规范文本（1424个chunks）
- `manifest.json`: 包元信息
- `import_to_db.py`: 导入脚本（适配当前系统）

## 导入方式

### 方式1：使用导入脚本（推荐，适合批量导入）

**前提条件**：
1. 数据库已创建并执行了 `docs/migrations/002_kb_tables.sql`
2. `.env` 文件配置了正确的 `DATABASE_URL`

**步骤**：

```bash
# 进入知识库包目录
cd docs/kb_package_20260131_142514

# 安装依赖（如果需要）
pip install psycopg

# 运行导入脚本
python import_to_db.py

# 或者干运行（不实际导入，只查看）
python import_to_db.py --dry_run
```

**脚本功能**：
- 自动创建 `file_object` 记录（如果不存在）
- 创建 `kb_source` 记录
- 批量导入 `kb_chunk`（跳过重复）
- 将 `kb_source` 标记为 `READY`

### 方式2：通过API上传（适合单个文件）

**API端点**：`POST /api/kb/sources/upload`

**请求示例**：
```bash
curl -X POST "http://localhost:8000/api/kb/sources/upload" \
  -H "Authorization: Bearer <token>" \
  -F "file=@<PDF文件路径>" \
  -F "name=<知识库名称>" \
  -F "kb_type=NORM"
```

**说明**：
- 上传后会自动触发 `index_kb_source_task` 异步处理
- 支持PDF和DOCX格式
- 会自动提取文本并分块

## 注意事项

### IMAGE_ONLY 文件处理

以下7个PDF为扫描件，`extract_method = IMAGE_ONLY`，当前无法直接提取文本：

1. 《生产建设项目水土保持技术标准》（GB 50433-2018）.pdf
2. 《水利工程设计概（估）算编制规定（水土保持工程）》.pdf
3. 2017最新版：《土地利用现状分类》（GBT 21010-2017） (1).pdf
4. 关于印发《生产建设项目水土保持方案技术审查要点》的通知（水保监〔2020〕63号）.pdf
5. 生产建设项目水土保持方案管理办法（2023年1月17日水利部令第53号发布）.pdf
6. 生产建设项目水土保持技术文件编写和印制格式规定（办水保【2018】135号） (最新）.pdf
7. 生产建设项目水土流失防治标准（GB50433-2018）.pdf

**处理方案**：
1. 使用OCR工具（如ocrmypdf）将PDF转换为可提取文本的版本
2. 重新运行 `tools/build_kb_package_v2.py` 生成新的知识库包
3. 或直接通过API上传OCR后的PDF

### 已可用的文件

以下3个文件已提取文本，可以直接导入：

1. **GB 51018-2014 水土保持工程设计规范 (2).pdf** - 942个chunks
2. **广东省水利水电工程设计估算编制规定.pdf** - 381个chunks  
3. **广东省水土保持条例.pdf** - 44个chunks

## 导入后验证

导入完成后，可以通过API查询：

```bash
# 查询所有知识库源
GET /api/kb/sources

# 查询某个源的chunks
GET /api/kb/sources/{source_id}/chunks
```

## 使用知识库

导入后，AI审查会自动使用这些知识库：

- `ai_review_tasks.py` 中的 `search_chunks()` 会检索相关条款
- 检索关键词：如"水土保持 规范 标准"
- 返回top_k个最相关的chunks作为AI审查的依据

## 故障排查

1. **导入失败**：检查数据库连接和schema配置
2. **chunks未导入**：检查 `kb_chunks.jsonl` 文件格式
3. **IMAGE_ONLY文件**：需要先OCR处理
4. **重复导入**：脚本会自动跳过重复的chunks（基于hash）
