# P0问题修复总结

## 修复内容

### P0-1: 章节编号 node_no 生成修复 ✅

**问题**：`_make_node_no()` 使用 `["1"] * (level-1)` 导致同级标题编号重复/不递增

**修复**：
- 实现分级计数器算法：`level_counters: dict[int, int]`
- 每遇到某level标题就递增该层计数，并清零更深层计数
- 正确生成编号：1, 1.1, 1.2, 1.2.1, 1.2.2...

**文件**：`SWS_Review_Cloud_Backend_MVP/app/worker/pipeline.py::_make_node_no()`

### P0-2: 标题识别兼容性增强 ✅

**问题**：只支持 "Heading 1/2/3"，不支持中文 "标题 1/2/3" 和编号前缀

**修复**：
- `_heading_level_from_style()` 支持 "标题 1", "标题1", "标题 1"（全角空格）
- 新增 `_heading_level_from_text_prefix()` 兜底方案：从文本前缀编号识别（如 "1.2.3 项目概况" -> level=3）
- `_get_heading_level()` 整合多种识别方式

**文件**：`SWS_Review_Cloud_Backend_MVP/app/worker/pipeline.py`

### P0-3: 表题抽取 ✅

**问题**：`doc_table(title=None)` 未抽取表题，导致格式审查误报、公式计算找不到表

**修复**：
- 在插入表格前，检查上一个段落是否是表题
- 匹配模式：`表X-X xxx` 或 `表X-X：xxx`
- 从表题中提取表号（如果表格内未找到）
- 更新 `doc_table.title` 字段

**文件**：`SWS_Review_Cloud_Backend_MVP/app/worker/pipeline.py::parse_docx_structure()`

### P0-4: PDF锚点对齐算法优化 ✅

**问题**：
- 去空白导致 `search_for()` 匹配失败
- 每个block扫全PDF所有页，性能差
- 大量 `page_no=None`

**修复**：
- `_extract_search_snippets()` 改为保留空白，归一化为单空格
- 生成多个候选snippet（前20/30/50字符）
- 利用blocks有序特性：从 `last_found_page` 往后搜索
- 移除末尾不完整的词（提高匹配率）

**文件**：`SWS_Review_Cloud_Backend_MVP/app/worker/pipeline.py::align_blocks_to_pdf()`

### P0-5: KB分页映射内存优化 ✅

**问题**：`char_to_page` 字典对几十万字符PDF会变成几十万entry，内存爆炸

**修复**：
- 改为页边界数组：`page_boundaries: list[tuple[int, int, int]]` = `[(char_start, char_end, page_no), ...]`
- `_chunk_text()` 使用 `bisect` 二分查找定位页
- `_extract_text_from_pdf()` 返回页边界列表而非字符级字典

**文件**：`SWS_Review_Cloud_Backend_MVP/app/worker/kb_tasks.py`

### P0-6: evidence_block_ids 混用问题修复 ✅

**问题**：规则中混用了 `outline_node.id` 和 `block.id`，导致UI无法定位证据

**修复**：
- 新增 `block_service.py`：提供 `get_heading_block_id()` 等辅助函数
- 修复所有规则：`content_review.py`, `format_review.py`, `missing_section.py`
- `insert_issue()` 自动从 `block_page_anchor` 反查 `page_no` 和 `anchor_rects`
- `IssueDraft.page_no` 改为可选（`int | None`）

**文件**：
- `SWS_Review_Cloud_Backend_MVP/app/services/block_service.py`（新增）
- `SWS_Review_Cloud_Backend_MVP/app/rule_engine/*.py`
- `SWS_Review_Cloud_Backend_MVP/app/services/review_run_service.py`

## 代码质量

- ✅ 所有代码通过 linter 检查
- ✅ 向后兼容性保持
- ✅ 异常处理完善

## 测试建议

1. **P0-1测试**：上传包含多级标题的文档，验证 `node_no` 是否正确（1, 1.1, 1.2, 1.2.1...）
2. **P0-2测试**：上传使用"标题 1"样式的文档，验证大纲是否正确提取
3. **P0-3测试**：上传包含表题的表格，验证 `doc_table.title` 是否正确填充
4. **P0-4测试**：验证 `block_page_anchor` 表的 `page_no` 填充率（应该显著提升）
5. **P0-5测试**：上传大PDF（>10MB），验证KB入库内存使用
6. **P0-6测试**：运行规则审查，验证 `review_issue.page_no` 和 `evidence_block_ids` 是否正确

## 后续优化建议

### 第二优先级（误报多、体验差）

1. **issue的page_no/anchor_rects全部从block_page_anchor反查**（已部分实现）
2. **sum_mismatch增加"分组范围"识别**，减少误报
3. **FactStore支持多来源**，不要同scope覆盖丢证据

### 第三优先级（规模化/商业化）

1. **review_checkpoint完整数据字典**：7类域→多个checkpoint→executor与参数
2. **规则库版本化**：不同地区/不同项目类型启用不同checkpoint集合
3. **评测体系**：precision/recall统计
